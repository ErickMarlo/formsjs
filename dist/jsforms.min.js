/*! jsforms 2015-07-08 */
Package.Register("forms.controls"),forms.controls.BaseControl=Class.extend({controlManager:null,indexedseparator:"___",init:function(a){this.controlManager=a},preprocess:function(a,b){var c=this;if(a.type||(a.type="Custom"),a.form||(a.form=b.form),this.checkId(a),a.parent=b,this.checkParentPath(a),a.form.idx.byid[a.id])throw'Field with id="'+a.id+'" already exists in idx.';a.form.idx.byid[a.id]=a,a.val=function(b){return"undefined"==typeof b?c.getval(a):void c.setval(a,b)}},_setupvalidation:function(a){a.validatefn=function(){var b=[];if("function"==typeof a.validate){var c=a.validate();return c&&b.push({id:a.id+"Function",source:a,message:c,isvalid:!1}),b}for(var d=0;a.validate&&d<a.validate.length;d++){var e=a.validate[d];for(var f in e){var g=forms.valid.ValidatorsInstance.idx[f];if(g){var h=g.isvalid(a,e);if(h)var i=g.success(a,e);else var i=g.error(a,e);i&&b.push({id:a.id+f,source:a,message:i,isvalid:h})}}}return b}},validate:function(a){return a.validatefn?a.validatefn():[]},destroy:function(a){delete a.form.idx.byid[a.id]},renderField:function(a,b){a.$jq=b},checkId:function(a){if(!a.id){var b=this.controlManager.instanceCounter;a.id="fld"+a.type+b,this.controlManager.instanceCounter++}},checkParentPath:function(a){a.parent&&(a.parent.path&&(a.parentPath=a.parent.path),a.parent.parentPath&&(a.parentPath=a.parent.parentPath))},scatter:function(a){this.onbeforescatter(a),a.path?this.scatterPath(a):a.parentPath?this.scatterParentPath(a):this.scatterSimple(a),this.onafterscatter(a)},onafterscatter:function(a){a.onafterscatter&&a.onafterscatter()},onbeforescatter:function(a){a.onbeforescatter&&a.onbeforescatter()},gather:function(a){a.path?this.gatherPath(a):a.parentPath?this.gatherParentPath(a):this.gatherSimple(a)},gatherSimple:function(a){var b=this.getval(a);a.form.db.value()[a.id]=b},scatterSimple:function(a){var b=a.form.db.value()[a.id];this.setval(a,b)},scatterParentPath:function(a){var b=a.parentPath+"/"+a.id.replace(this.indexedseparator,"/"),c=a.form.db.select(b);this.setval(a,c.value())},resolveVal:function(a,b){var c=a.id.split(this.indexedseparator);if(1==c.length)return b[a.id];if(2==c.length)return b[parseInt(c[0])][c[1]];throw"Invalid field id: "+a.id+". In case of indexed fields it must be in format 0.fieldid."},gatherParentPath:function(a){var b=this.getval(a),c=a.parentPath+"/"+a.id.replace(this.indexedseparator,"/"),d=a.form.db.select(c);if(0==d.length)throw"No json path object found for:"+c;d.replace(b)},scatterPath:function(a){var b=a.form.db.select(a.path).value();this.setval(a,b)},gatherPath:function(a){var b=a.$jq.val(),c=a.form.db.select(a.path);if(!c.value())throw"No path in json in:"+a.path;c.replace(b)},setval:function(a,b){a.$jq.val(b)},getval:function(a){var b=a.$jq.val();return b},onafterrender:function(a){this._setupvalidation(a),a.onafterrender&&a.onafterrender(a)}}),Package.Register("forms.controls"),forms.controls.BaseContainerControl=forms.controls.BaseControl.extend({renderField:function(a,b){var c=this;this.checkId(a),this.checkParentPath(a);var d=b(a);if(a.$jq=d,a.addItem=function(b){c.addItem(a,b)},!a.items)return d;for(var e=0;e<a.items.length;e++){var f=a.items[e];f.index=e;var g=forms.controls.ControlManagerInstance.renderer.renderField(f);d.append(g)}return d},preprocess:function(a,b){if(this._super(a,b),a.items)for(var c=0;c<a.items.length;c++)this.preprocess(a.items[c],a)},destroy:function(a){if(this._super(a),a.items)for(var b=0;b<a.items.length;b++)this.destroy(a.items[b])},addItem:function(a,b){var c=forms.controls.ControlManagerInstance.idx[b.type];c.preprocess(b,a);var d=c.controlManager.renderer.renderField(b);a.$jq.append(d),a.items||(a.items=[]),a.items.push(b),this.onafterrender(b)},scatter:function(a){if(a.path){var b=a.form.db.select(a.path).value();if(a.val=b,$.isArray(b)&&"function"==typeof a.createitem)for(var c=this,d=0;d<b.length;d++){var e=a.createitem(d,b[d]);if(e){var f=SpahQL.db(e);f.select("//items/*").map(function(){this.select("//id").map(function(){this.value().indexOf(c.indexedseparator)>-1||this.replace(""+d+c.indexedseparator+this.value())})}),this.addItem(a,e)}}}},gather:function(){},onafterrender:function(a){if(this._super(a),a.items)for(var b=0;b<a.items.length;b++){var c=a.items[b],d=forms.controls.ControlManagerInstance.idx[c.type];d&&d.onafterrender(c)}},validate:function(a){var b=this._super(a);if(!a.items)return b;for(var b=[],c=0;c<a.items.length;c++){var d=this.validate(a.items[c],b);b=b.concat(d)}return b}}),Package.Register("forms.controls"),forms.controls.CustomControl=forms.controls.BaseControl.extend({renderField:function(a){return this._super(a,$("<div></div>"))},setval:function(a,b){},getval:function(a){}}),Package.Register("forms.controls"),forms.controls.ColumnControl=forms.controls.BaseContainerControl.extend({renderField:function(a){return this._super(a,forms.controls.ControlManagerInstance.renderer.renderColumn)}}),Package.Register("forms.controls"),forms.controls.RowControl=forms.controls.BaseContainerControl.extend({renderField:function(a){return this._super(a,forms.controls.ControlManagerInstance.renderer.renderRow)}}),Package.Register("forms.controls"),forms.controls.BoxControl=forms.controls.BaseContainerControl.extend({renderField:function(a){return this._super(a,forms.controls.ControlManagerInstance.renderer.renderBox)}}),Package.Register("forms.controls"),forms.controls.TabsControl=forms.controls.BaseContainerControl.extend({_superContentFn:null,renderField:function(a){this._superContentFn=this._super,this.checkId(a);for(var b=forms.controls.ControlManagerInstance.renderer,c=b.renderTabsRoot(a),d=b.renderTabsHead(a),e=b.renderTabsBody(a),f=0;f<a.items.length;f++){var g=a.items[f];this._addItem(a,g,d,e,0==f)}c.append(d,e);var h=this;return a.addItem=function(b){h.addItem(a,b,d,e)},c},_addItem:function(a,b,c,d,e){var f=forms.controls.ControlManagerInstance.renderer,g=f.renderTabTitle(b,e);c.append(g);var h=f.renderTabContent(b,e);d.append(h);var i=this._superContentFn(b,function(){return h});h.append(i)},addItem:function(a,b,c,d){this._addItem(a,b,c,d),a.items||(a.items=[]),a.items.push(b)}}),Package.Register("forms.controls"),forms.controls.TabControl=forms.controls.BaseContainerControl.extend({}),Package.Register("forms.controls"),forms.controls.TableControl=forms.controls.BaseControl.extend({renderField:function(a){var b=forms.controls.ControlManagerInstance.renderer,c=b.renderTableContainer(a);this._super(a,c);var d=b.renderTable(a),e=b.renderTableHead(a),f=b.renderTableFoot(a),g=d.append(e,f);return c.append(g)},onafterrender:function(a){console.log("Table on afterrender:"+a.id+" "+a.items);var b={processing:!0,serverSide:!0};a.click&&(b.rowCallback=function(b,c){var d=$(b);d.bind("click",function(e){d.addClass("selected"),a.click(a,b._DT_RowIndex,c,d,e)})});for(var c=[],d=0;d<a.items.length;d++)c.push({data:a.items[d].id});b.columns=c,b=$.extend(b,a.options),$("#"+a.id).dataTable(b)},scatterField:function(a,b){}}),Package.Register("forms.controls"),forms.controls.TextControl=forms.controls.BaseControl.extend({renderField:function(a){var b=forms.controls.ControlManagerInstance.renderer.renderTextField(a);return this._super(a,$(b).find("input")),b}}),Package.Register("forms.controls"),forms.controls.InfoControl=forms.controls.BaseControl.extend({renderField:function(a){var b=forms.controls.ControlManagerInstance.renderer.renderInfoField(a);return this._super(a,$(b).find(".info")),b},setval:function(a,b){a.$jq.html(b)},getval:function(a){var b=a.$jq.html();return b}}),Package.Register("forms.controls"),forms.controls.DateControl=forms.controls.TextControl.extend({renderField:function(a){var b=$(c).find("input"),c=this._super(a,b);return c},onafterrender:function(a){this._super(a);var b=a.$jq;b.datepicker({format:"dd/mm/yyyy"})}}),Package.Register("forms.controls"),forms.controls.SelectControl=forms.controls.BaseControl.extend({renderField:function(a){var b=forms.controls.ControlManagerInstance.renderer.renderSelectField(a),c=$(b).find("select");this._super(a,c);var d=this;return a.load=function(b,c){d.load.call(a,b,c)},a.load(a.options,c),b},load:function(a,b){if(b||(b=this.$jq),a)for(var c=0;c<a.length;c++){var d=a[c];if(d.options){var e=$('<optgroup label="'+d.text+'"></optgroup>');e.data("data",d),b.append(e),this.load(d.options,e)}else{var f=$('<option value="'+d.value+'">'+d.text+"</option>");f.data("data",d),b.append(f)}}}}),Package.Register("forms.controls"),forms.controls.ButtonControl=forms.controls.BaseControl.extend({renderField:function(a){var b=forms.controls.ControlManagerInstance.renderer.renderButton(a);return this._super(a,$(b).find("a")),$("body").on("click","#"+a.id,function(b){return a.click(a)}),b},gather:function(){},scatter:function(){}}),Package.Register("forms.controls"),forms.controls.AccordionControl=forms.controls.BaseContainerControl.extend({renderField:function(a){this.checkId(a);var b=forms.controls.ControlManagerInstance.renderer,c=b.renderAccordionRoot(a),d=this._super(a,b.renderAccordionItemRoot);return c.append(d)}}),Package.Register("forms.controls"),forms.controls.AccordionItemControl=forms.controls.BaseContainerControl.extend({renderField:function(a){var b=forms.controls.ControlManagerInstance.renderer,c=this._super(a,b.renderAccordionItemBody),d=b.renderAccordionItemHead(a),e=b.renderAccordionItemContent(a);return $($("<div></div>").append(d,e.append(c)).children())}}),Package.Register("forms.controls"),forms.controls.BreadcrumbControl=forms.controls.BaseContainerControl.extend({renderField:function(a){return this._super(a,forms.controls.ControlManagerInstance.renderer.renderBreadcrumbContainer)}}),Package.Register("forms.controls"),forms.controls.BreadcrumbItemControl=forms.controls.BaseContainerControl.extend({renderField:function(a){return this._super(a,forms.controls.ControlManagerInstance.renderer.renderBreadcrumbItem)}}),Package.Register("forms.controls"),forms.controls.ControlManager=Class.extend({idx:{},instanceCounter:0,renderer:null,init:function(){this.idx.Custom=new forms.controls.CustomControl(this),this.idx.Text=new forms.controls.TextControl(this),this.idx.Info=new forms.controls.InfoControl(this),this.idx.Date=new forms.controls.DateControl(this),this.idx.Select=new forms.controls.SelectControl(this),this.idx.Button=new forms.controls.ButtonControl(this),this.idx.Column=new forms.controls.ColumnControl(this),this.idx.Row=new forms.controls.RowControl(this),this.idx.Box=new forms.controls.BoxControl(this),this.idx.Tabs=new forms.controls.TabsControl(this),this.idx.Tab=new forms.controls.TabControl(this),this.idx.Table=new forms.controls.TableControl(this),this.idx.Accordion=new forms.controls.AccordionControl(this),this.idx.AccordionItem=new forms.controls.AccordionItemControl(this)}}),forms.controls.ControlManagerInstance=new forms.controls.ControlManager,Package.Register("forms.valid"),forms.valid.Validators=Class.extend({idx:{},init:function(){this.idx.required={error:function(a,b){return"Field "+a.label+" is required."},success:function(a,b){},isvalid:function(a,b){return b.required===!0&&a.val()}},this.idx.minlen={error:function(a,b){return"Field "+a.label+" min. length is "+b.minlen+"."},success:function(a,b){},isvalid:function(a,b){return a.val().length>=b.minlen}},this.idx.maxlen={error:function(a,b){return"Field "+a.label+" max. length is "+b.maxlen+"."},success:function(a,b){},isvalid:function(a,b){return a.val().length<b.maxlen}},this.idx.regexp={error:function(a,b){return"Field "+a.label+" does`nt match expression "+b.regexp+"."},success:function(a,b){},isvalid:function(a,b){return b.regexp.test(a.val())}}}}),forms.valid.ValidatorsInstance=new forms.valid.Validators,Package.Register("forms.valid"),Package.Register("forms.valid.temp"),forms.valid.ValidationEngineView=Class.extend({show:function(a){for(var b=0;b<a.length;b++){var c=a[b],d=c.source.$jq;d.data("validationMessage",c.message),forms.valid.temp[c.id]={show:function(a,b,c,d){return a.data("validationMessage")}},d.addClass("validate[funcCall[forms.valid.temp."+c.id+".show]]")}a.length&&a[0].source.form.$jq.validationEngine("validate")}}),Package.Register("forms.renderer"),forms.renderer.BaseRenderer=Class.extend({init:function(){forms.controls.ControlManagerInstance.renderer=this},renderitems:function(a){for(var b=a.items,c=$('<div class="row">'),d=$('<div class="col-lg-12">'),e=0;e<b.length;e++){var f=b[e];d.append(this.renderField(f))}return c.append(d)},renderField:function(a){var b=forms.controls.ControlManagerInstance.idx[a.type];if(!b)throw"No renderer for field type:"+a.type;var c=b.renderField(a);return c}}),Package.Register("forms.renderer"),forms.renderer.BootstrapRenderer=forms.renderer.BaseRenderer.extend({renderColumn:function(a){return $('<div id="'+a.id+'" class="control-group col-lg-'+(a.cols?a.cols:"2")+'">')},renderRow:function(a){return $('<div id="'+a.id+'" class="row"></div>')},renderBox:function(a){var b=$('<div class="toolbar"></div>'),c=$('<ul class="nav pull-right"></ul>'),d=$('<li><a class="accordion-toggle minimize-box" data-toggle="collapse" href="#'+a.id+' div">'+(a.icon?'<i class="icon-chevron-up"></i>':"")+"</a></li>"),e=b.append(c.append(d)),f=$('<div class="box" id="'+a.id+'"></div>');return $(f).append($("<header></header>").append("<h5>"+(a.icon?'<i class="icon-'+a.icon+'"></i>':"")+(a.label?a.label:"")+"</h5>",e))},getValidations:function(a){if(a.validate)for(var b=0;b<a.validate.length;b++){a.validate[b]}},renderTextField:function(a){var b=this._getLabel(a)+'<div class="'+(a.controlcols?"col-lg-"+a.controlcols:"")+'"><input class="form-control" type="text" id="'+a.id+'" '+(a.placeholder?'placeholder="'+a.placeholder+'"':"")+' value=""></div>',c=$('<div class=""></div>').append(b);return c},renderInfoField:function(a){var b=this._getLabel(a)+'<div class="'+(a.controlcols?"col-lg-"+a.controlcols:"")+'"><input class="form-control" id="'+a.id+'" disabled="disabled"></div>',c=$('<div class=""></div>').append(b);return c},_getLabel:function(a){return'<label for="'+a.id+'" class="control-label '+(a.labelcols?"col-lg-"+a.labelcols:"")+'">'+a.label+"</label>"},renderSelectField:function(a){var b=this._getLabel(a)+'<div class="'+(a.controlcols?"col-lg-"+a.controlcols:"")+'"><select id="'+a.id+'" class="form-control"></div>',c=$('<div class=""></div>').append(b);return c},renderButton:function(a){var a=$('<button id="'+a.id+'" class="btn btn-primary btn-lg" data-toggle="modal">'+a.label+"</button>");return a},renderTabsRoot:function(a){return $('<div id="'+a.id+'"></div>')},renderTabsHead:function(a){return $('<ul class="nav nav-tabs"></ul>')},renderTabsBody:function(a){return $('<div class="tab-content"></ul>')},renderTabTitle:function(a,b){return $("<li"+(b?' class="active"':"")+'><a href="#'+a.id+'" data-toggle="tab">'+a.label+"</li>")},renderTabContent:function(a,b){return $('<div class="tab-pane fade '+(b?" in active":"")+'" id="'+a.id+'"></div>')},renderTableContainer:function(a){return $('<div class="table-responsive"></div>')},renderTable:function(a){return $('<table id="'+a.id+'" class="table table-striped table-bordered table-hover"></table>')},renderTableHead:function(a){return this.renderTableHeadFoot(a,"thead")},renderTableFoot:function(a){return this.renderTableHeadFoot(a,"tfoot")},renderTableHeadFoot:function(a,b){for(var c=$("<"+b+"></"+b+">"),d=$("<tr></tr>"),e=0;e<a.items.length;e++)d.append($("<th></th>").html(a.items[e].label));return c.append(d),c},renderAccordionRoot:function(a){return $('<div id="'+a.id+'"></div>')},renderAccordionItemRoot:function(a){return $('<div class="panel panel-default"></div>')},renderAccordionItemHead:function(a){return $('<div class="panel-heading"></div>').append($('<h4 class="panel-title"></h4>').append('<a data-toggle="collapse" data-parent="#'+a.parent.id+'" href="#'+a.id+'">'+a.label+"</a>"))},renderAccordionItemContent:function(a){return $('<div id="'+a.id+'" class="panel-collapse collapse'+(0===a.index?" in":"")+'">')},renderAccordionItemBody:function(a){return $('<div class="panel-body"></div>')},clearBreadcrumb:function(a){$("ul#"+a.id+".breadcrumb").html("")},renderBreadcrumbContainer:function(a){return $('<ul id="'+a.id+'" class="breadcrumb"></ul>')},renderBreadcrumbItem:function(a,b,c){return b?$('<li id="'+a.id+'" class="active">'+a.label+"</li>"):$('<li id="'+a.id+'"></li>').append($('<a href="#">'+a.label+"</a>").click(function(){c&&c.call(a)}))}}),Package.Register("forms"),forms.Application=Class.extend({navigation:[],activeform:null,formsdefs:{},forms:{},rootUrl:null,selector:null,init:function(a){$.extend(this,a)},addItem:function(a){},loadform:function(claz,params,callback){var ctx=this,frmpath=(this.rootUrl?this.rootUrl:"")+claz.replace(/\./g,"/");$.ajax({url:frmpath,type:"POST",data:params,dataType:"script",success:function(scr){ctx.defidx[claz]=eval(scr),callback&&callback.call(ctx)}})},createform:function(a,b){var c=this,d=function(a){var d=new a(b);c.formsdefs[d.id]=a,d.render(c.selector),c.forms[d.id]=d};if("function"==typeof a)return void d(a);if("object"==typeof a)a=forms.BaseForm.extend(a),d(a);else if("string"==typeof a)throw"Not implemented yet"},destroyform:function(a){this.activeform==a&&(this.activeform=null);for(var b=0;b<this.navigation.length;b++)if(this.navigation[b].id==a){this.navigation.splice(b,1);break}var c=this.forms[a];c.destroy(),delete this.forms[a],delete this.formsdefs[a]},showform:function(a){this.activeform=a,this.navigation.length>0&&this.navigation[this.navigation.length-1].show(!1),this.navigation.push(this.forms[a]),this.navigation[this.navigation.length-1].show(!0),this.updatebreadcrumb()},back:function(){if(!(this.navigation.length<=1)){var a=this.navigation[this.navigation.length-1],b=this.navigation[this.navigation.length-2];a.show(!1),b.show(!0),this.navigation.splice(this.navigation.length-1,1),this.activeform=b.id,this.updatebreadcrumb()}},updatebreadcrumb:function(){var a=forms.controls.ControlManagerInstance.renderer,b={id:"appbreadcrumb"};a.clearBreadcrumb(b),$(this.selector).find("#"+b.id).length||$(this.selector).prepend(a.renderBreadcrumbContainer(b));for(var c=this,d=0;d<this.navigation.length;d++){var e=this.navigation[d];$("#"+b.id).append(a.renderBreadcrumbItem(e,e.id==this.activeform,function(){c.activeform!==this.id&&c.back()}))}}}),Package.Register("forms"),forms.BaseForm=Class.extend({items:null,db:null,rendererImpl:null,validationViewer:null,$jq:null,idx:{byid:{}},init:function(){this.rendererImpl=eval("new forms.renderer."+this.renderer+"Renderer()"),this.validationViewer&&(this.validationViewer=eval("new forms.valid."+this.validationViewer+"View()")),this.preprocess(),this.itemsdb=SpahQL.db(this.items)},render:function(a){var b=this.rendererImpl.renderitems(this);this.$jq=$('<form class="horizontal"></form>').append(b),$(a).append(this.$jq),this.onafterrender(this)},onafterrender:function(a){for(var b=0;b<a.items.length;b++){var c=a.items[b],d=forms.controls.ControlManagerInstance.idx[c.type];if(!d)return;d.onafterrender(c)}},preprocess:function(){for(var a=0;a<this.items.length;a++)this.preprocessfield(this.items[a])},preprocessfield:function(a,b){a.form=this;var c=forms.controls.ControlManagerInstance.idx[a.type];c.preprocess(a,b)},destroy:function(){for(var a=0;a<this.items.length;a++){var b=this.items[a],c=forms.controls.ControlManagerInstance.idx[b.type];c.destroy(b)}this.$jq.remove()},initDb:function(a){this.db||(a||(a={}),this.db=SpahQL.db(a))},scatter:function(a){this.initDb(a);for(var b=0;b<this.items.length;b++)this.scatterField(this.items[b])},gather:function(){this.initDb();for(var a=0;a<this.items.length;a++)this.gatherField(this.items[a])},gatherField:function(a){var b=forms.controls.ControlManagerInstance.idx[a.type];if(b&&(b.gather(a),a.items))for(var c=0;c<a.items.length;c++)this.gatherField(a.items[c])},scatterField:function(a){var b=forms.controls.ControlManagerInstance.idx[a.type];if(b&&(b.scatter(a),a.items))for(var c=0;c<a.items.length;c++)this.scatterField(a.items[c])},show:function(a){a?this.$jq.show():this.$jq.hide()},validate:function(){for(var a=[],b=0;b<this.items.length;b++){var c=forms.controls.ControlManagerInstance.idx[this.items[b].type],d=this.items[b],e=c.validate(d);a=a.concat(e)}var f=this;return{result:a,show:function(){f.validationViewer.show(a)}}}});
/*! jsforms 2015-06-09 */
!function(){this.Package=function(){},Package.Register=function(a){if(!this.Exists(a)){for(var b=!1,c="",d=a.split("."),e=0;e<d.length;e++)""!=c&&(c+="."),c+=d[e],b=this.Exists(c),b||this.Create(c);if(b)throw"Package: "+a+" is already defined."}},Package.Create=function(_Src){eval("window."+_Src+" = new Object();")},Package.Exists=function(_Src){return eval("var NE = false; try{if("+_Src+"){NE = true;}else{NE = false;}}catch(err){NE=false;}"),NE}}(),function(){var a=!1,b=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;this.Class=function(){},Class.extend=function(c){function d(){!a&&this.init&&this.init.apply(this,arguments)}var e=this.prototype;a=!0;var f=new this;a=!1;for(var g in c)f[g]="function"==typeof c[g]&&"function"==typeof e[g]&&b.test(c[g])?function(a,b){return function(){var c=this._super;this._super=e[a];var d=b.apply(this,arguments);return this._super=c,d}}(g,c[g]):c[g];return d.prototype=f,d.prototype.constructor=d,d.extend=arguments.callee,d}}(),SpahQL_classRegister=function(a,b){for(var c=a.split("."),d="undefined"==typeof window?{}:window,e="undefined"==typeof exports?{}:exports,d="undefined"==typeof SpahQL?d:SpahQL,e="undefined"==typeof SpahQL?e:SpahQL,f=1;f<c.length;f++){var g=c[f],h=g.toLowerCase();f<c.length-1?(d[g]=d[g]||{},d=d[g],e[h]=e[h]||{},e=e[h]):(d[g]=b,e[h]=b)}},SpahQL_classExtend=function(a,b,c,d,e){var f;"function"==typeof c?(f=d||{},d=e||{},e=c):(f=c||{},d=d||{},e=d.init);var g;c=Object.create(b.prototype);for(g in d)Object.defineProperty(c,g,{value:d[g],enumerable:!1});g=e?e:c.init?function(){this.init&&this.init.apply(this,arguments)}:function(){},g.prototype=c;for(var h in b)g[h]=b[h];for(var i in f)g[i]=f[i];return SpahQL_classRegister(a,g),g},SpahQL_classCreate=function(a,b,c,d){return SpahQL_classExtend(a,Object,b,c,d)},SpahQL=SpahQL_classExtend("SpahQL",Array,{db:function(a){return this.item("/",a,a)},result:function(a,b,c){return{path:a,value:b,sourceData:a?c:c||b}},item:function(a,b,c){return new this(this.result(a,b,c))},select:function(a,b,c,d){if(a=this.QueryParser.parseQuery(a),a.assertion)throw new this.SpahQLRunTimeError("Cannot call SpahQL.select() with an assertion query.");return new this(this.QueryRunner.select(a,b,c,d))},assert:function(a,b,c,d){return a=this.QueryParser.parseQuery(a),this.QueryRunner.assert(a,b,c,d)},verbose:!1,log:function(a){return this.verbose&&"undefined"!=typeof console&&console.log.apply(console,arguments),a},inBrowser:function(){return"undefined"!=typeof window&&"object"==typeof window.location},isHeadless:function(){return!this.inBrowser()},inCommonJS:function(){return"object"==typeof exports}},{init:function(a){if(Object.defineProperty(this,"dh",{value:SpahQL.DataHelper,enumerable:!1}),a){a=1<arguments.length?Array.prototype.slice.call(arguments):a,a=a.value&&"function"!=typeof a.value?[a]:a;for(var b in a)this.push(a[b])}},item:function(a){return new SpahQL(this[a])},first:function(){return this.item(0)},last:function(){return this.item(this.length-1)},path:function(){return this[0]?this[0].path:null},paths:function(){return this.map(function(){return this.path()})},value:function(){return this[0]?this[0].value:null},values:function(){return this.map(function(){return this.value()})},sourceData:function(){return this[0]?this[0].sourceData:null},each:function(a){for(var b=0;b<this.length&&0!=a.apply(this.item(b),[b,this.length]);b++);return this},map:function(a){for(var b=[],c=0;c<this.length;c++)b.push(a.apply(this.item(c),[c,this.length]));return b},select:function(a){var b=[];return this.each(function(){SpahQL.select(a,this.sourceData(),this.value(),this.path()).each(function(){b.push(this[0])})}),new SpahQL(b)},assert:function(a){var b=!0;return this.each(function(){return SpahQL.assert(a,this.sourceData(),this.value(),this.path())?void 0:b=!1}),b},parentPath:function(a){return a=a||this.path(),a=a&&"/"!=a?a.substring(0,a.lastIndexOf("/")):null,""==a?"/":a},parentPaths:function(){var a=this;return this.map(function(){return a.parentPath(this.path())})},parent:function(a){a=a||this[0];var b=this.parentPath(a.path);return b&&a?SpahQL.select(b,a.sourceData):null},parents:function(){var a=[],b=this;return this.each(function(){var c=b.parent(this[0]);c&&c[0]&&a.push(c[0])}),new SpahQL(a)},keyName:function(a){return a=a||this.path(),a&&"/"!=a?a.substring(a.lastIndexOf("/")+1):null},keyNames:function(){var a=this;return this.map(function(){return a.keyName(this.path())})},type:function(a){return a=a||this.value(),this.dh.objectType(a)},types:function(){var a=this;return this.map(function(){return a.type(this.value())})},containing:function(a,b){var c,d;c="string"==typeof a?[a]:"function"==typeof a.paths?a.paths():a,d=b?c.length:1;var e=[],f=0;a:for(;f<this.length;f++){var g=this[f];if(g.path)for(var h=0,i=0;i<c.length;i++)if(0==c[i].indexOf(g.path)&&(""==c[i].charAt(g.path.length)||"/"==c[i].charAt(g.path.length))&&(h++,h>=d)){e.push(g);continue a}}return new SpahQL(e)},containingAll:function(a){return this.containing(a,!0)},filter:function(a){var b=[];return this.each(function(){this.assert(a)&&b.push(this[0])}),new SpahQL(b)},concat:function(a){for(var b=[],c=0;c<this.length;c++)b.push(this[c]);for(c=0;c<a.length;c++)b.push(a[c]);return new SpahQL(b)},detach:function(){var a=this.dh.deepClone(this[0]?this[0].value:null);return SpahQL.db(a)},clone:function(){for(var a=[],b=[],c=[],d=0;d<this.length;d++){var e=this[d].sourceData,f=this[d].path;if(f){var g=b.indexOf(e);0>g?(g=SpahQL.db(this.dh.deepClone(e)),b.push(e),c.push(g)):g=c[g],e=g.select(f),e[0]&&a.push(e[0])}else a.push(this.dh.deepClone(this[d]))}return new SpahQL(a)},set:function(a,b,c){var d=c||this[0];if(!d)return this;"object"==this.dh.objectType(a)?c=a:(c={},c[a]=b),a=!1,b=this.dh.deepClone(d.value);for(var e in c){var f=c[e],g=this.dh.coerceKeyForObject(e,d.value);null!=g&&!this.dh.eq(f,d.value[g])&&(d.value[g]=f,a=!0)}return a&&this.resultModified(d,b),this},setAll:function(a,b){for(var c=0;c<this.length;c++)this.set(a,b,this[c]);return this},replace:function(a,b){var c=b||this[0],d=this.keyName(c.path);if(d&&c){var e=c.value;c.value=a;var f=this.parent(c);f?f.set(d,a):this.resultModified(c,e)}return this},replaceAll:function(a){for(var b=0;b<this.length;b++)this.replace(a,this[b]);return this},rename:function(a,b){var c=b||this[0];if(c){var d=c.value,e=this.parent(c);e?(e.set(a,d),e.destroy(c)):this.resultModified(c,d)}return this},renameAll:function(a){for(var b=0;b<this.length;b++)this.rename(a,this[b]);return this},destroy:function(a,b){if(a&&"object"==typeof a||(b=a,a=this[0]),a&&b){var c,d=this.type(a.value),e=SpahQL.DataHelper.coerceKeyForObject(b,a.value);if("array"==d)c=a.value.slice(0),a.value.splice(e,1);else if("object"==d){c={};for(var f in a.value)c[f]=a.value[f];delete a.value[e]}this.resultModified(a,c)}else a&&(c=this.keyName(a.path),(d=this.parent(a))&&c&&d.destroy(c));return this},destroyAll:function(a){for(var b=this.length-1;b>-1;b--)this.destroy(this[b],a);return this},listen:function(a,b,c){var d=b?b:a;for(a=b?a:null,b=0;b<this.length;b++){var e=this[b],f="/"==e.path?a||e.path:e.path+(a||"");c?SpahQL.Callbacks.removeCallbackForPathModifiedOnObject(f,e.sourceData,d):SpahQL.Callbacks.addCallbackForPathModifiedOnObject(f,e.sourceData,d)}return this},unlisten:function(a,b){this.listen(a,b,!0)},resultModified:function(a,b){SpahQL.Callbacks.pathModifiedOnObject(a.path,a.sourceData,b,a.value)},valueOf:function(){return JSON.parse(this.toString())},toString:function(){return JSON.stringify(1<this.length?this.map(function(a){return a.value}):0<this.length?this[0].value:null)}}),"undefined"!=typeof module&&"undefined"!=typeof module.exports&&(module.exports=SpahQL),"undefined"!=typeof window&&(window.SpahQL=SpahQL),SpahQL_classCreate("SpahQL.Callbacks",{callbacks:{},reset:function(){this.callbacks={}},callbacksForPathInObject:function(a,b){var c=this.callbacks[a],d=[];if(c)for(var e in c)c[0]==b&&d.push(a);return d},pathModifiedOnObject:function(a,b,c,d){if(a){var e=[];a=SpahQL.DataHelper.compare(c,d,a);for(var f in a)for(a=f;0<=a.lastIndexOf("/");)0>e.indexOf(a)&&e.push(a),a=0==a.lastIndexOf("/")&&1<a.length?"/":a.substring(0,a.lastIndexOf("/"));for(e.sort(function(a,b){return"/"==a?1:"/"==b?-1:a.split("/").length>b.split("/").length?-1:1}),SpahQL.log("Path modified on data store, formulated the following dispatch strategy: ["+e.join(" -> ")+"]. Data store: ",b),f=0;f<e.length;f++)if(a=e[f],c=this.callbacks[a],SpahQL.log("Triggering registered path callbacks for "+a+": "+(c?c.length+" callbacks to trigger":"No callbacks to trigger")),c)for(d=0;d<c.length;d++)if(c[d][0]==b){for(var g=[],h=0;h<e.length;h++)e[h]!=a&&0==e[h].indexOf(a)&&g.push(e[h].substring(a.length));c[d][1](SpahQL.select(a,b),a,g)}}},addCallbackForPathModifiedOnObject:function(a,b,c){this.callbacks[a]=this.callbacks[a]||[],this.callbacks[a].push([b,c])},removeCallbackForPathModifiedOnObject:function(a,b,c){if(a=this.callbacks[a])for(var d=a.length-1;d>=0;d--)if(a[d][0]==b&&a[d][1]==c){a.splice(d,1);break}}}),SpahQL.Errors={},SpahQL.Errors.SpahQLError=function(a){this.name="SpahQLError",this.message=a||""},SpahQL.Errors.SpahQLError.prototype=Error.prototype,SpahQL.Errors.SpahQLRunTimeError=function(a){this.name="SpahQLRunTimeError",this.message=a||""},SpahQL.Errors.SpahQLRunTimeError.prototype=SpahQL.Errors.SpahQLError.prototype,SpahQL_classCreate("SpahQL.Query",{},{init:function(a,b,c,d,e){this.primaryToken=a||null,this.comparisonOperator=b||null,this.secondaryToken=c||null,this.assertion=d||!1,this.rawString=e||null}}),SpahQL_classCreate("SpahQL.QueryParser",{queryCache:{},parseQuery:function(a){var b=this.cleanQuery(a);if(this.queryCache[b])return this.queryCache[b];var c=new SpahQL.Query;c.rawString=a;for(var d,e=0;d=SpahQL.Token.parseAt(e,b);){var f=d[0];d=d[1],d instanceof SpahQL.Token.ComparisonOperator?c.comparisonOperator?this.throwParseAt(e,b,"Found unexpected TOKEN_COMPARISON_OPERATOR, expected EOL"):!c.primaryToken||c.primaryToken&&c.secondaryToken?this.throwParseAt(e,b,"Found unexpected TOKEN_COMPARISON_OPERATOR, expected evaluatable token type"):(c.comparisonOperator=d,c.assertion=!0):("function"==typeof d.toSet&&(d=d.toSet()),c.primaryToken?c.comparisonOperator?c.secondaryToken?this.throwParseErrorAt(e,b,"Unexpected token, expected EOL"):c.secondaryToken=d:this.throwParseErrorAt(e,b,"Unexpected token, expected EOL or TOKEN_COMPARISON_OPERATOR"):c.primaryToken=d),e=f}if(c.primaryToken){if(!c.comparisonOperator||c.secondaryToken)return this.queryCache[b]=c,SpahQL.log("Generated and cached query '"+a+"' ->",c),c;this.throwParseErrorAt(b.length-1,b,"Query contains comparison operator but has no secondary term - expected TOKEN_SET_LITERAL or TOKEN_SELECTION_QUERY")}else this.throwParseErrorAt(0,b,"Failed to parse query, expected TOKEN_SET_LITERAL or TOKEN_SELECTION_QUERY")},cleanQuery:function(a){for(var b=[],c="",d=0;d<a.length;d++){var e=a.charAt(d);'"'!=e&&"'"!=e||0!=d&&"\\"==a.charAt(d-1)?" "==e?0<b.length&&(c+=e):c+=e:(b[b.length-1]==e?b.pop():b.push(e),c+=e)}return c},throwParseErrorAt:function(a,b,c){throw Error("Parse error: '"+(c||"failure")+"' at index "+a+" in query '"+b+"'.")}}),SpahQL_classCreate("SpahQL.QueryRunner",{select:function(a,b,c,d){if(a.assertion)throw new SpahQL.Errors.SpahQLRunTimeError("Attempted to select from an assertion query.");return a.primaryToken.evaluate(b,c||b,d)},assert:function(a,b,c,d){return this.evalAssertion(a.primaryToken,a.secondaryToken,a.comparisonOperator,b,c||b,d)},evalAssertion:function(a,b,c,d,e,f){var g=a.evaluate(d,e,f);a=[];for(var h in g)a.push(g[h].value);if(!b)return SpahQL.DataHelper.truthySet(a);b=b.evaluate(d,e,f),f=[];for(var i in b)f.push(b[i].value);switch(c.evaluate(d,e)[0].value){case SpahQL.Token.ComparisonOperator.COMPARISON_STRICT_EQUALITY:return SpahQL.DataHelper.eqSetStrict(a,f);case SpahQL.Token.ComparisonOperator.COMPARISON_INEQUALITY:return!SpahQL.DataHelper.eqSetStrict(a,f);case SpahQL.Token.ComparisonOperator.COMPARISON_ROUGH_EQUALITY:return SpahQL.DataHelper.eqSetRough(a,f);case SpahQL.Token.ComparisonOperator.COMPARISON_LT:return SpahQL.DataHelper.ltSet(a,f);case SpahQL.Token.ComparisonOperator.COMPARISON_GT:return SpahQL.DataHelper.gtSet(a,f);case SpahQL.Token.ComparisonOperator.COMPARISON_LTE:return SpahQL.DataHelper.lteSet(a,f);case SpahQL.Token.ComparisonOperator.COMPARISON_GTE:return SpahQL.DataHelper.gteSet(a,f);case SpahQL.Token.ComparisonOperator.COMPARISON_JOINT_SET:return SpahQL.DataHelper.jointSet(a,f);case SpahQL.Token.ComparisonOperator.COMPARISON_DISJOINT_SET:return!SpahQL.DataHelper.jointSet(a,f);case SpahQL.Token.ComparisonOperator.COMPARISON_SUPERSET:return SpahQL.DataHelper.superSet(a,f);case SpahQL.Token.ComparisonOperator.COMPARISON_SUBSET:return SpahQL.DataHelper.superSet(f,a)}}}),SpahQL_classCreate("SpahQL.DataHelper",{compare:function(a,b,c){var d="/"==c?"":c,e={},f=this.objectType(a),g=this.objectType(b),f="object"!=f&&"array"!=f,g="object"!=g&&"array"!=g;if(this.eq(a,b))return e;if(f&&g){var h=this.modificationSymbol(b,a);h&&(e[c]=[h,a,b])}if(!g)for(var i in b)for(k in h=this.compare(f?void 0:a[i],b[i],d+"/"+i))e[k]=h[k];if(!f)for(var j in a){i=this.compare(a[j],g?void 0:b[j],d+"/"+j);for(var k in i)e[k]=i[k]}return e[c]||(d=this.modificationSymbol(b,a))&&(e[c]=[d,a,b]),e},modificationSymbol:function(a,b){return"null"==this.objectType(b)?"+":"null"==this.objectType(a)?"-":a!=b?"~":void 0},objectType:function(a){return null==a||void 0==a?"null":"object"==typeof a?"[object Array]"==Object.prototype.toString.call(a)?"array":"object":typeof a},eq:function(){var a,b;for(a=arguments[0],b=1;b<arguments.length;b++){var c=arguments[b],d=this.objectType(a);if(d!=this.objectType(c))return!1;if("array"==d){if(c.length!=a.length)return!1;for(d=0;d<c.length;d++)if(!this.eq(c[d],a[d]))return!1}else if("object"==d){if(Object.keys(c).length!=Object.keys(a).length)return!1;for(var e in c)if(!this.eq(c[e],a[e]))return!1}else if(c!=a)return!1;a=c}return!0},hashKeys:function(a){return Object.keys(a).sort()},hashValues:function(a){var b,c=[];for(b in a)c.push(a[b]);return c},mathGte:function(a,b){return this.mathCompare(a,b,function(a,b){return a>=b})},mathGt:function(a,b){return this.mathCompare(a,b,function(a,b){return a>b})},mathLte:function(a,b){return this.mathCompare(a,b,function(a,b){return b>=a})},mathLt:function(a,b){return this.mathCompare(a,b,function(a,b){return b>a})},mathCompare:function(a,b,c){var d=this.objectType(a),e=this.objectType(b);return d!=e||"number"!=d&&"string"!=d?!1:c.apply(this,[a,b])},eqRough:function(a,b){var c=this.objectType(a),d=this.objectType(b);if(c!=d)return!1;switch(c){case"string":return this.eqStringRough(a,b);case"number":return this.eqNumberRough(a,b);case"array":return this.eqArrayRough(a,b);case"object":return this.eqHashRough(a,b);case"boolean":return this.eqBooleanRough(a,b);default:return!1}},eqStringRough:function(a,b){return a.match(RegExp(b,"g"))},eqNumberRough:function(a,b){return Math.floor(a)==Math.floor(b)},eqArrayRough:function(a,b){return this.jointSet(a,b)},eqHashRough:function(a,b){for(var c in a)if(b[c]&&this.eq(a[c],b[c]))return!0;return!1},eqBooleanRough:function(a,b){return a&&b||!a&&!b},eqSetStrict:function(a,b){if(a.length!=b.length)return!1;for(var c=[],d=0;d<a.length;d++)for(var e=a[d],f=0;f<b.length;f++)this.eq(e,b[f])&&0>c.indexOf(f)&&c.push(f);return c.length==a.length},eqSetRough:function(a,b){return this.jointSetWithCallback(a,b,function(a,b){return this.eqRough(a,b)})},jointSet:function(a,b){return this.jointSetWithCallback(a,b,function(a,b){return this.eq(a,b)})},gteSet:function(a,b){return this.jointSetWithCallback(a,b,function(a,b){return this.mathGte(a,b)})},lteSet:function(a,b){return this.jointSetWithCallback(a,b,function(a,b){return this.mathLte(a,b)})},gtSet:function(a,b){return this.jointSetWithCallback(a,b,function(a,b){return this.mathGt(a,b)})},ltSet:function(a,b){return this.jointSetWithCallback(a,b,function(a,b){return this.mathLt(a,b)})},jointSetWithCallback:function(a,b,c){for(var d=0;d<b.length;d++)for(var e=0;e<a.length;e++)if(c.apply(this,[a[e],b[d]]))return!0;return!1},superSet:function(a,b){for(var c=[],d=0;d<b.length;d++){var e=b[d],f=0;a:for(;f<a.length;f++){var g=a[f];if(-1==c.indexOf(f)&&this.eq(e,g)){c.push(f);break a}}}return b.length==c.length},truthySet:function(a){for(var b=0;b<a.length;b++)if(a[b])return!0;return!1},coerceKeyForObject:function(a,b){var c=this.objectType(b);return"array"==c?(c=parseInt(a),isNaN(c)?null:c):"object"==c?(c=a.toString(),c.match(/^\s*$/)?null:c):null},deepClone:function(a){var b=this.objectType(a);if("array"==b||"object"==b){var c,b="array"==b?[]:{};for(c in a)b[c]=this.deepClone(a[c]);return b}return a}}),SpahQL_classCreate("SpahQL.Strategiser",{},{init:function(){this.strategies=[],this.categories={}},count:function(a){return this.getStrategies(a).length},addStrategy:function(a,b,c){return a=this.commoniseStrategy(a,b,c),this.strategies.push(a),this.categories[a.category]=this.categories[a.category]||[],this.categories[a.category].push(a),a},removeStrategy:function(a){var b=this.strategies.indexOf(a);return b>=0?(this.strategies.splice(b,1),(b=this.categories[a.category])&&(a=b.indexOf(a),a>=0&&b.splice(a,1)),!0):!1},commoniseStrategy:function(a,b,c){if(a._commonised)return a;"function"==typeof b&&(c=b,b=null);var d=a.paths||a.path;"string"==typeof d&&(d=[d]);var e=a["if"]?!0:!1,f=(e?a["if"]:a.unless)||null;return c=a.action||c,b=b||a.category||"*",{paths:d,expectation:e,condition:f,action:c,category:b,_commonised:!0}},getStrategies:function(a){if(!a)return this.strategies;a="string"==typeof a?[a]:a;var b,c=[];for(b in this.strategies){var d=this.strategies[b],e=d.category;("*"==e||0<=a.indexOf(e))&&c.push(d)}return c},run:function(a,b,c,d){b=this.getStrategies(b),this.locked=!0,this.runStrategyLoop(0,b,a,c,d)},runStrategyLoop:function(a,b,c,d,e){function f(){return h.runStrategyLoop(a+1,b,c,d,e)}if(a>=b.length)return this.completed(c,d,e);var g=b[a],h=this;return g.condition&&c.assert(g.condition)!=g.expectation?f():void this.runStrategyQueryLoop(0,g,c,d,f)},runStrategyQueryLoop:function(a,b,c,d,e){function f(){return g.runStrategyQueryLoop(a+1,b,c,d,e)}if(a>=b.paths.length)return e();var g=this,h={done:f},i=c.select(b.paths[a]),j=b.action;return 0<i.length?j(i,c,d,h):f()},completed:function(a,b,c){c(a,b)}}),SpahQL_classCreate("SpahQL.Token",{parseAt:function(a,b){return SpahQL.Token.ComparisonOperator.parseAt(a,b)||SpahQL.Token.String.parseAt(a,b)||SpahQL.Token.Numeric.parseAt(a,b)||SpahQL.Token.Boolean.parseAt(a,b)||SpahQL.Token.Set.parseAt(a,b)||SpahQL.Token.SelectionQuery.parseAt(a,b)||null},throwParseErrorAt:function(a,b,c){throw Error("Parse error: '"+(c||"failure")+"' at index "+a+" in query '"+b+"'.")}}),SpahQL_classCreate("SpahQL.Token.Base",{parseAt:function(){throw"I should have been overridden. Something is disastrously wrong."}},{init:function(){},throwRuntimeError:function(a,b){throw Error("Parse error: '"+(b||"failure to execute")+"' in token "+a+".")}}),SpahQL_classExtend("SpahQL.Token.Simple",SpahQL.Token.Base,{},{init:function(a){this.value="undefined"!=typeof a?a:null},toSet:function(){return new SpahQL.Token.Set([this])},evaluate:function(){return[SpahQL.result(null,this.value)]}}),SpahQL_classExtend("SpahQL.Token.String",SpahQL.Token.Simple,{ATOM_QUOTE_SINGLE:"'",ATOM_QUOTE_DOUBLE:'"',ATOM_ESCAPE:"\\",parseAt:function(a,b){var c=b.charAt(a);if(c==this.ATOM_QUOTE_SINGLE||c==this.ATOM_QUOTE_DOUBLE){for(var d=0,e="";;)if(d++,b.length<a+d)this.throwParseErrorAt(a,b,"Encountered EOL when expecting "+(c==this.ATOM_QUOTE_SINGLE?"ATOM_QUOTE_SINGLE":"ATOM_QUOTE_DOUBLE"));else{if(b.charAt(a+d)==c){d++;break}b.charAt(a+d)==this.ATOM_ESCAPE?(e+=b.charAt(a+d+1),d++):e+=b.charAt(a+d)}return[a+d,new this(e)]}return null}},{}),SpahQL_classExtend("SpahQL.Token.Numeric",SpahQL.Token.Simple,{ATOM_NUMERIC_POINT:".",ATOM_NUMERIC_NEGATIVE:"-",parseAt:function(a,b){var c=b.charAt(a),d=/\d/;if(c.match(d)||c==this.ATOM_NUMERIC_NEGATIVE&&b.charAt(a+1).match(d)){for(var e,f=0;f++,!(b.length<a+f);)if(b.charAt(a+f)==this.ATOM_NUMERIC_POINT){if(e){f--;break}e=!0,c+=b.charAt(a+f)}else{if(!b.charAt(a+f).match(d))break;c+=b.charAt(a+f)}return[a+f,new this(e?parseFloat(c):parseInt(c,10))]}return null}}),SpahQL_classExtend("SpahQL.Token.Boolean",SpahQL.Token.Simple,{ATOM_BOOLEAN_TRUE:"true",ATOM_BOOLEAN_FALSE:"false",parseAt:function(a,b){return b.substr(a,this.ATOM_BOOLEAN_TRUE.length)==this.ATOM_BOOLEAN_TRUE?[a+this.ATOM_BOOLEAN_TRUE.length,new this(!0)]:b.substr(a,this.ATOM_BOOLEAN_FALSE.length)==this.ATOM_BOOLEAN_FALSE?[a+this.ATOM_BOOLEAN_FALSE.length,new this(!1)]:null}}),SpahQL_classExtend("SpahQL.Token.Set",SpahQL.Token.Base,{ATOM_SET_START:"{",ATOM_SET_END:"}",ATOM_SET_ARRAY_DELIMITER:",",ATOM_SET_RANGE_DELIMITER:"..",parseAt:function(a,b){if(b.charAt(a)==this.ATOM_SET_START){var c,d=a+1,e=[],f=!1,g=!1;if(b.charAt(d)==this.ATOM_SET_END)return[d+1,new this];for(;c=SpahQL.Token.parseAt(d,b);){var h=c[1],i=[SpahQL.Token.Numeric,SpahQL.Token.String,SpahQL.Token.Boolean,SpahQL.Token.SelectionQuery],j=!1;for(a in i)if(h instanceof i[a]){j=!0;break}if(j)if(d=c[0],e.push(h),b.charAt(d)==this.ATOM_SET_ARRAY_DELIMITER)g&&this.throwParseErrorAt(d,b,"Found unexpected ATOM_SET_ARRAY_DELIMITER in set literal that already used the range delimiter."),f=!0,d++;else if(b.substr(d,this.ATOM_SET_RANGE_DELIMITER.length)==this.ATOM_SET_RANGE_DELIMITER)f&&this.throwParseErrorAt(d,b,"Found unexpected ATOM_SET_RANGE_DELIMITER in set literal that already used the array delimiter."),g=!0,d+=this.ATOM_SET_RANGE_DELIMITER.length;else{if(b.charAt(d)==this.ATOM_SET_END){d++;break}this.throwParseErrorAt(d,b,"Found unexpected character '"+b.charAt(d)+"' in set literal, expecting one of ATOM_SET_ARRAY_DELIMITER, ATOM_SET_RANGE_DELIMITER, ATOM_SET_END.")}else this.throwParseErrorAt(d,b,"Found unexpected token in set literal. Set literals may only contain string, numeric, boolean and selection query values.")}return[d,new this(e,g)]}return null}},{init:function(a,b){this.tokens=a||[],this.isRange=b||!1},evaluate:function(a,b,c){var d=[];if(this.isRange){2!=this.tokens.length&&this.throwRuntimeError(this,"Tried to evaluate range with "+this.tokens.length+" tokens, expected 2 tokens. Tokens: "+this.tokens.join(", "));var e=this.tokens[0].evaluate(a,b,c);if(b=this.tokens[1].evaluate(a,b,c),0==e.length||0==b.length)return d;if(a=e[0].value,b=b[0].value,c=SpahQL.DataHelper.objectType(a),e=SpahQL.DataHelper.objectType(b),c!=e)throw new SpahQL.Errors.SpahQLRunTimeError("Illegal range with start type '"+c+"' and end type '"+e+"'. Ranges must use the same type at each end.");"number"==c?d=d.concat(this.evalNumericRange(a,b)):"string"==c?d=d.concat(this.evalStringRange(a,b)):new SpahQL.Errors.SpahQLRunTimeError("Unsupported type used in range. Ranges support only strings and numbers.")}else for(e in this.tokens)d=d.concat(this.tokens[e].evaluate(a,b,c));return d},evalNumericRange:function(a,b){var c=[];if(a>b)for(var d=a;d>=b;d--)c.push(SpahQL.result(null,d));else for(d=a;b>=d;d++)c.push(SpahQL.result(null,d));return c},evalStringRange:function(a,b){var c=[];if(a==b)return[SpahQL.result(null,a)];if(a>b||a.length!=b.length)return c;for(var d=[],e=!0,f=0;f<a.length;f++){var g=a.charCodeAt(f);d[f]=g>=48&&57>=g||g>=65&&90>=g||g>=97&&122>=g?!1:!0,(e=1==d[f]&&1==e)&&f==a.length-1&&(d[f]=!1)}e=function(a){for(a-=1;a>-2;a--)if(0==d[a])return a},f=a+"";a:for(;c.push(SpahQL.result(null,f)),f!=b;){var g=e(a.length),h="";b:for(;;){var h=!1,i=f.charAt(g).charCodeAt(0),j=void 0;if(57==i?(h=!0,j=48):90==i?(h=!0,j=65):122==i?(h=!0,j=97):127==i?(h=!0,j=i):j=i+1,h=[String.fromCharCode(j),h],f=f.split(""),f.splice(g,1,h[0]),f=f.join(""),1!=h[1])break b;if(g=e(g),0>g)break a}}return c}}),SpahQL_classExtend("SpahQL.Token.ComparisonOperator",SpahQL.Token.Simple,{COMPARISON_OPERATORS:"== =~ > < >= <= != }~{ }>{ }<{ }!{".split(" "),COMPARISON_STRICT_EQUALITY:"==",COMPARISON_ROUGH_EQUALITY:"=~",COMPARISON_INEQUALITY:"!=",COMPARISON_LT:"<",COMPARISON_GT:">",COMPARISON_LTE:"<=",COMPARISON_GTE:">=",COMPARISON_JOINT_SET:"}~{",COMPARISON_SUPERSET:"}>{",COMPARISON_SUBSET:"}<{",COMPARISON_DISJOINT_SET:"}!{",parseAt:function(a,b){return 0<=this.COMPARISON_OPERATORS.indexOf(b.substr(a,3))?[a+3,new this(b.substr(a,3))]:0<=this.COMPARISON_OPERATORS.indexOf(b.substr(a,2))?[a+2,new this(b.substr(a,2))]:0<=this.COMPARISON_OPERATORS.indexOf(b.substr(a,1))?[a+1,new this(b.substr(a,1))]:null}}),SpahQL_classExtend("SpahQL.Token.FilterQuery",SpahQL.Token.Simple,{ATOM_FILTER_QUERY_START:"[",ATOM_FILTER_QUERY_END:"]",parseAt:function(a,b){if(b.charAt(a)==this.ATOM_FILTER_QUERY_START){for(var c,d=a+1,e=1,f="";e>0;){var g=b.charAt(d);if(g==this.ATOM_FILTER_QUERY_START)e++,f+=g,d++;else if(g==this.ATOM_FILTER_QUERY_END){if(e--,d++,0==e)break;f+=g}else(c=SpahQL.Token.String.parseAt(d,b))?(f+=b.substring(d,c[0]),d=c[0]):(f+=g,d++)}if(0<f.length)return[d,new this(SpahQL.QueryParser.parseQuery(f))];this.throwParseErrorAt(d,b,"Found unexpected ATOM_FILTER_QUERY_END, expected TOKEN_SELECTION_QUERY or TOKEN_ASSERTION_QUERY. Looked like those brackets were empty - make sure they have a query in them.")}return null}},{evaluate:function(a,b){return SpahQL.QueryRunner.assert(this.value,a,b)}}),SpahQL_classExtend("SpahQL.Token.PathComponent",SpahQL.Token.Base,{ATOM_PATH_DELIMITER:"/",ATOM_PROPERTY_IDENTIFIER:".",ATOM_PATH_WILDCARD:"*",parseAt:function(a,b){if(b.charAt(a)==this.ATOM_PATH_DELIMITER){var c=a+1,d=new this,e=!1;if(b.charAt(c)==this.ATOM_PATH_DELIMITER&&(d.recursive=!0,c++),b.charAt(c)==this.ATOM_PATH_WILDCARD)d.key=this.ATOM_PATH_WILDCARD,c++;else{b.charAt(c)==this.ATOM_PROPERTY_IDENTIFIER?(e=!0,c++):b.charAt(c)==this.ATOM_PATH_DELIMITER&&this.throwParseErrorAt(c,b,"3 path delimiters found in a row. Maximum legal count is 2.");var f=SpahQL.Token.KeyName.parseAt(c,b);!f&&e?this.throwParseError(c,b,"Found unexpected character '"+b.charAt(c)+"' when expecting TOKEN_PROPERTY"):f&&(e?d.property=f[1]:d.key=f[1],c=f[0])}for(;e=SpahQL.Token.FilterQuery.parseAt(c,b);)d.filterQueries.push(e[1]),c=e[0];return[c,d]}return null}},{PROPERTY_TYPE:"type",PROPERTY_SIZE:"size",PROPERTY_EXPLODE:"explode",PROPERTY_KEY:"key",PROPERTY_PATH:"path",init:function(a,b,c,d){this.key=a||null,this.property=b||null,this.recursive=c||!1,this.filterQueries=d||[]},evaluate:function(a,b,c){var d,e=c&&"/"!=c?c:"";if(null==this.key&&null==this.property?d=[SpahQL.result(c,b,a)]:null!=this.key?d=this.fetchResultsFromObjectByKey(this.key.value,a,b,e,this.recursive):null!=this.property&&(d=this.fetchResultsFromObjectByProperty(this.property.value,a,b,e,this.recursive)),0<d.length&&0<this.filterQueries.length)for(b=0;b<this.filterQueries.length;b++){var e=this.filterQueries[b],f=[];for(c=0;c<d.length;c++){var g=d[c];e.evaluate(a,g.value)&&0>f.indexOf(g)&&f.push(g)}d=f}return d},fetchResultsFromObjectByKey:function(a,b,c,d,e){var f=SpahQL.DataHelper.objectType(c),g=[];if("array"==f||"object"==f)for(var h in c){var f=c[h],i=SpahQL.DataHelper.objectType(f),j=d+"/"+h;(a==SpahQL.QueryParser.ATOM_PATH_WILDCARD||a.toString()==h.toString())&&g.push(SpahQL.result(j,f,b)),!e||"array"!=i&&"object"!=i||(g=g.concat(this.fetchResultsFromObjectByKey(a,b,f,j,e)))}return g},fetchResultsFromObjectByProperty:function(a,b,c,d,e){var f=SpahQL.DataHelper.objectType(c),g=d+"/."+a,h=[];switch(a){case this.PROPERTY_SIZE:switch(f){case"array":case"string":h.push(SpahQL.result(g,c.length,b));break;case"object":h.push(SpahQL.result(g,SpahQL.DataHelper.hashKeys(c).length,b))}break;case this.PROPERTY_TYPE:h.push(SpahQL.result(g,f,b));break;case this.PROPERTY_EXPLODE:if("string"==f)for(g=0;g<c.length;g++)h.push(SpahQL.result(d+"/"+g,c.charAt(g),b));break;case this.PROPERTY_PATH:h.push(SpahQL.result(g,d||"/",b));break;case this.PROPERTY_KEY:var i=d&&""!=d&&"/"!=d?d.substring(d.lastIndexOf("/")+1):d;h.push(SpahQL.result(g,i,b));break;default:throw new SpahQL.Errors.SpahQLRunTimeError("Unrecognised property token '"+a+"'.")}if(e&&("array"==f||"object"==f))for(var j in c)h=h.concat(this.fetchResultsFromObjectByProperty(a,b,c[j],d+"/"+j,e));return h}}),SpahQL_classExtend("SpahQL.Token.SelectionQuery",SpahQL.Token.Base,{ATOM_PATH_ROOT:"$",parseAt:function(a,b){var c=b.charAt(a),d=SpahQL.Token.PathComponent.parseAt(a,b);if(c==this.ATOM_PATH_ROOT||d){var e=new this,f=a;for(c==this.ATOM_PATH_ROOT&&((d=SpahQL.Token.PathComponent.parseAt(f+1,b))||this.throwParseErrorAt(f+1,b,"Found unexpected character '"+b.charAt(f+1)+"', expected TOKEN_PATH_COMPONENT"),e.useRoot=!0),f=d[0],e.pathComponents.push(d[1]);c=SpahQL.Token.PathComponent.parseAt(f,b);)e.pathComponents.push(c[1]),f=c[0];return[f,e]}return null}},{init:function(a,b){this.pathComponents=a||[],this.useRoot=b||!1},evaluate:function(a,b,c){for(b=[SpahQL.result((this.useRoot?null:c)||"/",this.useRoot?a:b)],c=0;c<this.pathComponents.length;c++){for(var d=this.pathComponents[c],e=[],f=0;f<b.length;f++)e=e.concat(d.evaluate(a,b[f].value,b[f].path));if(b=e,0==b.length)break}return b}}),SpahQL_classExtend("SpahQL.Token.KeyName",SpahQL.Token.Simple,{parseAt:function(a,b){for(var c,d=/[\w\d_-]/,e=a,f="";c=b.charAt(e).match(d);)f+=c[0],e++;return 0<f.length?[e,new this(f)]:null}}),Package.Register("forms"),forms.BaseForm=Class.extend({items:null,db:null,rendererImpl:null,$jq:null,idx:{byid:{}},init:function(){this.rendererImpl=eval("new forms.renderer."+this.renderer+"Renderer()"),this.itemsdb=SpahQL.db(this.items)},render:function(a){this.$jq=this.rendererImpl.renderitems(this),$(a).append(this.$jq),this.onafterrender(this)},onafterrender:function(a){for(var b=0;b<this.items.length;b++)this.onafterrenderfield(this.items[b])},onafterrenderfield:function(a){var b=forms.controls.ControlManagerInstance.idx[a.type];if(b&&(b.onafterrenderfield(a),a.items))for(var c=0;c<a.items.length;c++)this.onafterrenderfield(a.items[c])},initDb:function(a){this.db||(a||(a={}),this.db=SpahQL.db(a))},scatter:function(a){this.initDb(a);for(var b=0;b<this.items.length;b++)this.scatterField(this.items[b])},gather:function(){this.initDb();for(var a=0;a<this.items.length;a++)this.gatherField(this.items[a])},gatherField:function(a){var b=forms.controls.ControlManagerInstance.idx[a.type];if(b&&(b.gather(a),a.items))for(var c=0;c<a.items.length;c++)this.gatherField(a.items[c])},scatterField:function(a){var b=forms.controls.ControlManagerInstance.idx[a.type];if(b&&(b.scatter(a),a.items))for(var c=0;c<a.items.length;c++)this.scatterField(a.items[c])}});
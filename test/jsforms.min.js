/*! jsforms 2015-08-02 */
Package.Register("forms.controls"),forms.controls.BaseControl=Class.extend({controlManager:null,indexedseparator:"___",init:function(a){this.controlManager=a},preprocess:function(a,b){if(a.form||(a.form=b.form),a.target||(a.target="body"),this.checkId(a),a.parent=b,this.checkParentPath(a),a.form.idx.byid[a.id])throw'Field with id="'+a.id+'" already exists in idx.';a.form.idx.byid[a.id]=a,this._setuprefnotifications(a),a.updatelabel=function(b){a.$jq.find('[_target="label"]').html(b)}},_setuprefnotifications:function(a){if(a.ref){var b=a.form.refmap;if(b[a.ref])var c=b[a.ref];else{var c=[];b[a.ref]=c}c.push(a)}},_setupvalidation:function(a){a.validatefn=function(){var b=[];if("function"==typeof a.validate){var c=a.validate();return c&&b.push({id:a.id+"Function",source:a,message:c,isvalid:!1}),b}for(var d=0;a.validate&&d<a.validate.length;d++){var e=a.validate[d];for(var f in e){var g=forms.valid.ValidatorsInstance.idx[f];if(g){var h=g.isvalid(a,e);if(h)var i=g.success(a,e);else var i=g.error(a,e);i&&b.push({id:a.id+f,source:a,message:i,isvalid:h})}}}return b}},validate:function(a){return a.validatefn?a.validatefn():[]},destroy:function(a){delete a.form.idx.byid[a.id]},renderField:function(a,b){a.$jq=b},checkId:function(a){if(!a.id){var b=this.controlManager.instanceCounter;a.id="fld"+a.type+b,this.controlManager.instanceCounter++}},checkParentPath:function(a){a.parent&&(a.parent.path&&(a.parentPath=a.parent.path),a.parent.parentPath&&(a.parentPath=a.parent.parentPath))},onafterrender:function(a){this._setupvalidation(a),a.onafterrender&&a.onafterrender(a)},onchange:function(a,b){a.onchange&&a.onchange(b);for(var c=a.parent;c;)c.onchange&&c.onchange(a,b),c=c.parent;a.form.onchange(a,b)}}),Package.Register("forms.controls"),forms.controls.BaseContainerControl=forms.controls.BaseControl.extend({renderField:function(a,b){var c=this;this.checkId(a),this.checkParentPath(a);var d=b(a);if(a.$jq=d,a.addItem=function(b){c.addItem(a,b)},a.find=function(b){var d=null,e=function(a){if(a&&!d)for(var f=0;f<a.length;f++){var g=a[f].id;g==b||g.indexOf(c.indexedseparator+b)>-1?d=a[f]:e(a[f].items)}};return e(a.items),d},!a.items)return d;for(var e=0;e<a.items.length;e++){var f=a.items[e],g=forms.controls.ControlManagerInstance.renderer.renderField(f);"body"==f.target?d.append(g):d.find('[_target="'+f.target+'"]').append(g)}return d},preprocess:function(a,b){if(this._super(a,b),a.items)for(var c=0;c<a.items.length;c++){var d=forms.controls.ControlManagerInstance.idx[a.items[c].type];d.preprocess(a.items[c],a)}},destroy:function(a){if(this._super(a),a.items)for(var b=0;b<a.items.length;b++)this.destroy(a.items[b])},addItem:function(a,b){var c=this;a.items||(a.items=[]),b.index=a.items.length,a.items.push(b);var d=SpahQL.db(b);d.select("//items/*").map(function(){this.select("//id").map(function(){this.value().indexOf(c.indexedseparator)>-1||this.replace(""+(a.items.length-1)+c.indexedseparator+this.value())})});var e=forms.controls.ControlManagerInstance.idx[b.type];e.preprocess(b,a);var f=e.controlManager.renderer.renderField(b);a.$jq.append(f),this.onafterrender(b)},scatter:function(a){if(a.path){var b=a.form.db.select(a.path).value();if(a.val=b,$.isArray(b)&&"function"==typeof a.createitem)for(var c=0;c<b.length;c++){var d=a.createitem(c,b[c]);d&&this.addItem(a,d)}}},gather:function(){},onafterrender:function(a){if(this._super(a),a.items)for(var b=0;b<a.items.length;b++){var c=a.items[b],d=forms.controls.ControlManagerInstance.idx[c.type];d&&d.onafterrender(c)}},validate:function(a){var b=this._super(a);if(!a.items)return b;for(var b=[],c=0;c<a.items.length;c++){var d=this.validate(a.items[c],b);b=b.concat(d)}return b}}),Package.Register("forms.controls"),forms.controls.CustomControl=forms.controls.BaseControl.extend({renderField:function(a){return this._super(a,$("<div></div>"))}}),Package.Register("forms.controls"),forms.controls.ValueControl=forms.controls.BaseControl.extend({preprocess:function(a,b){var c=this;a.val=function(b){return"undefined"==typeof b?c.getval(a):void c.setval(a,b)},this._super(a,b)},scatter:function(a){this.onbeforescatter(a),a.path?this.scatterPath(a):a.parentPath?this.scatterParentPath(a):this.scatterSimple(a),this.onafterscatter(a)},onafterscatter:function(a){a.onafterscatter&&a.onafterscatter()},onbeforescatter:function(a){a.onbeforescatter&&a.onbeforescatter()},gather:function(a){a.path?this.gatherPath(a):a.parentPath?this.gatherParentPath(a):this.gatherSimple(a)},gatherSimple:function(a){var b=this.getval(a);a.form.db.value()[a.id]=b},scatterSimple:function(a){var b=a.form.db.value()[a.id];this.setval(a,b)},scatterParentPath:function(a){var b=a.parentPath+"/"+a.id.replace(this.indexedseparator,"/"),c=a.form.db.select(b);this.setval(a,c.value())},resolveVal:function(a,b){var c=a.id.split(this.indexedseparator);if(1==c.length)return b[a.id];if(2==c.length)return b[parseInt(c[0])][c[1]];throw"Invalid field id: "+a.id+". In case of indexed fields it must be in format 0.fieldid."},gatherParentPath:function(a){var b=this.getval(a);if(void 0!=b){var c=a.parentPath+"/"+a.id.replace(this.indexedseparator,"/"),d=a.form.db.select(c);if(0==d.length)throw"No json path object found for:"+c;d.replace(b)}},scatterPath:function(a){var b=a.form.db.select(a.path).value();this.setval(a,b)},gatherPath:function(a){var b=a.$jq.val(),c=a.form.db.select(a.path);if(!c.value())throw"No path in json in:"+a.path;c.replace(b)},setval:function(a,b){a.$jq.val(b),a.form.onchange(a)},getval:function(a){var b=a.$jq.val();return b},onafterrender:function(a){this._super(a),this.setupvaluechange(a)},setupvaluechange:function(a){}}),Package.Register("forms.controls"),forms.controls.ColumnControl=forms.controls.BaseContainerControl.extend({renderField:function(a){return this._super(a,forms.controls.ControlManagerInstance.renderer.renderColumn)}}),Package.Register("forms.controls"),forms.controls.RowControl=forms.controls.BaseContainerControl.extend({renderField:function(a){return this._super(a,forms.controls.ControlManagerInstance.renderer.renderRow)}}),Package.Register("forms.controls"),forms.controls.BoxControl=forms.controls.BaseContainerControl.extend({renderField:function(a){var b=forms.controls.ControlManagerInstance.renderer,c=this._super(a,b.renderBoxContent),d=b.renderBox(a);return d.append(c)}}),Package.Register("forms.controls"),forms.controls.TabsControl=forms.controls.BaseContainerControl.extend({_superContentFn:null,renderField:function(a){this._superContentFn=this._super,this.checkId(a);var b=forms.controls.ControlManagerInstance.renderer,c=b.renderTabsRoot(a),d=b.renderTabsHead(a),e=b.renderTabsBody(a);a.$jq=e;for(var f=0;f<a.items.length;f++){var g=a.items[f];this._addItem(a,g,d,e,0==f)}c.append(d,e);var h=this;return a.addItem=function(b){h.addItem(a,b,d,e)},c},_addItem:function(a,b,c,d,e){var f=forms.controls.ControlManagerInstance.renderer,g=f.renderTabTitle(b,e);c.append(g);var h=f.renderTabContent(b,e);d.append(h);var i=this._superContentFn(b,function(){return h});h.append(i)},addItem:function(a,b,c,d){this._addItem(a,b,c,d),a.items||(a.items=[]),a.items.push(b)}}),Package.Register("forms.controls"),forms.controls.TabControl=forms.controls.BaseContainerControl.extend({}),Package.Register("forms.controls"),forms.controls.TableControl=forms.controls.BaseControl.extend({renderField:function(a){var b=forms.controls.ControlManagerInstance.renderer,c=b.renderTableContainer(a);this._super(a,c);var d=b.renderTable(a),e=b.renderTableHead(a),f=b.renderTableFoot(a),g=d.append(e,f);return c.append(g)},onafterrender:function(a){var b={processing:!0,serverSide:!0};a.click&&(b.rowCallback=function(b,c){var d=$(b);d.bind("click",function(e){d.addClass("selected"),a.click(a,b._DT_RowIndex,c,d,e)})});for(var c=[],d=0;d<a.columns.length;d++)c.push({data:a.columns[d].id});b.columns=c,b=$.extend(b,a.options),$("#"+a.id).dataTable(b)}}),Package.Register("forms.controls"),forms.controls.TextControl=forms.controls.ValueControl.extend({renderField:function(a){var b=forms.controls.ControlManagerInstance.renderer.renderTextField(a);return this._super(a,$(b).find("input")),b},setupvaluechange:function(a){var b=this;a.$jq.on("keyup blur",function(c){b.onchange(a,c)})}}),Package.Register("forms.controls"),forms.controls.TextareaControl=forms.controls.ValueControl.extend({renderField:function(a){var b=forms.controls.ControlManagerInstance.renderer.renderTextareaField(a);return this._super(a,$(b).find("textarea")),b},setupvaluechange:function(a){var b=this;a.$jq.on("keyup blur",function(c){b.onchange(a,c)})}}),Package.Register("forms.controls"),forms.controls.InfoControl=forms.controls.ValueControl.extend({renderField:function(a){var b=forms.controls.ControlManagerInstance.renderer.renderInfoField(a);return this._super(a,$(b).find(".info")),b},setval:function(a,b){a.$jq.val(b)},getval:function(a){}}),Package.Register("forms.controls"),forms.controls.DateControl=forms.controls.TextControl.extend({onafterrender:function(a){this._super(a);var b=a.$jq;b.datepicker({format:"dd/mm/yyyy"})},setupvaluechange:function(a){this._super(a);var b=this;a.$jq.on("changeDate",function(c){b.onchange(a,c)})}}),Package.Register("forms.controls"),forms.controls.SelectControl=forms.controls.ValueControl.extend({renderField:function(a){var b=forms.controls.ControlManagerInstance.renderer.renderSelectField(a),c=$(b).find("select");this._super(a,c);var d=this;return a.load=function(b,c){d.load.call(a,b,c)},a.load(a.options,c),b},load:function(a,b){if(b||(b=this.$jq),a)for(var c=0;c<a.length;c++){var d=a[c];if(d.options){var e=$('<optgroup label="'+d.text+'"></optgroup>');e.data("data",d),b.append(e),this.load(d.options,e)}else{var f=$('<option value="'+d.value+'">'+d.text+"</option>");f.data("data",d),b.append(f)}}},setupvaluechange:function(a){var b=this;a.$jq.on("change",function(c){b.onchange(a,c)})}}),Package.Register("forms.controls"),forms.controls.ButtonControl=forms.controls.BaseControl.extend({renderField:function(a){var b=this.getRenderFn()(a);return this._super(a,b),$("body").on("click","#"+a.id,function(b){return a.click?a.click(a):void 0}),b},getRenderFn:function(){return forms.controls.ControlManagerInstance.renderer.renderButton}}),Package.Register("forms.controls"),forms.controls.AccordionControl=forms.controls.BaseContainerControl.extend({renderField:function(a){this.checkId(a);var b=forms.controls.ControlManagerInstance.renderer,c=b.renderAccordionRoot(a),d=this._super(a,b.renderAccordionItemRoot);return c.append(d)}}),Package.Register("forms.controls"),forms.controls.AccordionItemControl=forms.controls.BaseContainerControl.extend({renderField:function(a){var b=forms.controls.ControlManagerInstance.renderer,c=this._super(a,b.renderAccordionItemBody),d=b.renderAccordionItemHead(a),e=b.renderAccordionItemContent(a);return a.updatelabel=function(a){d.find('[_target="label"]').html(a)},$($("<div></div>").append(d,e.append(c)).children())}}),Package.Register("forms.controls"),forms.controls.BreadcrumbControl=forms.controls.BaseContainerControl.extend({renderField:function(a){return this._super(a,forms.controls.ControlManagerInstance.renderer.renderBreadcrumbContainer)}}),Package.Register("forms.controls"),forms.controls.BreadcrumbItemControl=forms.controls.BaseContainerControl.extend({renderField:function(a){return this._super(a,forms.controls.ControlManagerInstance.renderer.renderBreadcrumbItem)}}),Package.Register("forms.controls"),forms.controls.MessageControl=forms.controls.BaseControl.extend({renderField:function(a){var b=forms.controls.ControlManagerInstance.renderer.renderMessage(a);b.hide(),this._super(a,b);var c=this;return a.show=function(b,d){c.show(a,b,d)},a.hide=function(){c.hide(a)},a.clear=function(){c.clear(a)},b},hide:function(a){a.$jq.hide()},clear:function(a){a.$jq.find("div").remove()},show:function(a,b,c){forms.controls.ControlManagerInstance.renderer.changeAlertType(a,b);for(var d=0,e=c.length;e>d;d++){var f=$("<div></div>").html(c[d]);a.$jq.append(f)}a.$jq.show()}}),Package.Register("forms.controls"),forms.controls.ControlManager=Class.extend({idx:{},instanceCounter:0,renderer:null,init:function(){this.idx.Custom=new forms.controls.CustomControl(this),this.idx.Text=new forms.controls.TextControl(this),this.idx.Textarea=new forms.controls.TextareaControl(this),this.idx.Info=new forms.controls.InfoControl(this),this.idx.Date=new forms.controls.DateControl(this),this.idx.Select=new forms.controls.SelectControl(this),this.idx.Button=new forms.controls.ButtonControl(this),this.idx.ToolbarButton=new forms.controls.ToolbarButtonControl(this),this.idx.Column=new forms.controls.ColumnControl(this),this.idx.Row=new forms.controls.RowControl(this),this.idx.Box=new forms.controls.BoxControl(this),this.idx.Message=new forms.controls.MessageControl(this),this.idx.Tabs=new forms.controls.TabsControl(this),this.idx.Tab=new forms.controls.TabControl(this),this.idx.Table=new forms.controls.TableControl(this),this.idx.Accordion=new forms.controls.AccordionControl(this),this.idx.AccordionItem=new forms.controls.AccordionItemControl(this)}}),forms.controls.ControlManagerInstance=new forms.controls.ControlManager,Package.Register("forms.valid"),forms.valid.Validators=Class.extend({idx:{},init:function(){this.idx.required={error:function(a,b){return"Field "+a.label+" is required."},success:function(a,b){},isvalid:function(a,b){return b.required===!0&&a.val()}},this.idx.minlen={error:function(a,b){return"Field "+a.label+" min. length is "+b.minlen+"."},success:function(a,b){},isvalid:function(a,b){return a.val().length>=b.minlen}},this.idx.maxlen={error:function(a,b){return"Field "+a.label+" max. length is "+b.maxlen+"."},success:function(a,b){},isvalid:function(a,b){return a.val().length<b.maxlen}},this.idx.regexp={error:function(a,b){return"Field "+a.label+" does`nt match expression "+b.regexp+"."},success:function(a,b){},isvalid:function(a,b){return b.regexp.test(a.val())}}}}),forms.valid.ValidatorsInstance=new forms.valid.Validators,Package.Register("forms.valid"),Package.Register("forms.valid.temp"),forms.valid.ValidationEngineView=Class.extend({show:function(a){for(var b=0;b<a.length;b++){var c=a[b],d=c.source.$jq;d.data("validationMessage",c.message),forms.valid.temp[c.id]={show:function(a,b,c,d){return a.data("validationMessage")}},d.addClass("validate[funcCall[forms.valid.temp."+c.id+".show]]")}a.length&&a[0].source.form.$jq.validationEngine("validate")}}),Package.Register("forms.renderer"),forms.renderer.BaseRenderer=Class.extend({init:function(){forms.controls.ControlManagerInstance.renderer=this},renderitems:function(a){for(var b=a.items,c=$('<div class="row">'),d=$('<div class="col-lg-12">'),e=0;e<b.length;e++){var f=b[e];d.append(this.renderField(f))}return c.append(d)},renderField:function(a){var b=forms.controls.ControlManagerInstance.idx[a.type];if(!b)throw"No renderer for field type:"+a.type;var c=b.renderField(a);return c}}),Package.Register("forms.renderer"),forms.renderer.BootstrapRenderer=forms.renderer.BaseRenderer.extend({renderForm:function(a){return $('<form class="horizontal"></form>')},renderColumn:function(a){return $('<div id="'+a.id+'" class="control-group'+(a.cols?" col-lg-"+a.cols:"")+'">')},renderRow:function(a){return $('<div id="'+a.id+'" class="row"></div>')},renderBox:function(a){for(var b=$('<div class="toolbar"></div>'),c=$('<ul class="nav" _target="toolbar"></ul>'),d=0,e=a.items.length;e>d;d++){var f=a.items[d];if("toolbar"===f.target){var g=$('<a id="'+f.id+'" href="#">'+(f.icon?'<i class="icon-'+f.icon+'"></i>':"")+(f.label?f.label:"")+"</a>"),h=$("<li></li>").append(g);c.append(h)}}var i=$('<li><a class="accordion-toggle minimize-box" data-toggle="collapse" href="#'+a.id+'Body"><i class="icon-chevron-up"></i></a></li>'),j=b.append(c.append(i)),k=$('<div class="box dark" id="'+a.id+'"></div>');return $(k).append($("<header></header>").append("<h5>"+(a.icon?'<i class="icon-'+a.icon+'"></i>':"")+(a.label?a.label:"")+"</h5>",j))},renderToolbarButton:function(a){var b=$('<a id="'+a.id+'" href="#">'+(a.icon?'<i class="icon-'+a.icon+'"></i>':"")+(a.label?a.label:"")+"</a>");return b},renderBoxContent:function(a){var b=$('<div id="'+a.id+'Body" class="accordion-body collapse in body"></div>');return b},getValidations:function(a){if(a.validate)for(var b=0;b<a.validate.length;b++){a.validate[b]}},renderTextField:function(a){var b=this._getLabel(a)+'<div class="'+(a.controlcols?"col-lg-"+a.controlcols:"")+'"><input class="form-control" type="text" id="'+a.id+'" '+(a.placeholder?'placeholder="'+a.placeholder+'"':"")+' value=""></div>',c=$('<div class=""></div>').append(b);return c},renderTextareaField:function(a){var b=this._getLabel(a)+'<div class="'+(a.controlcols?"col-lg-"+a.controlcols:"")+'"><textarea class="form-control" id="'+a.id+'" '+(a.placeholder?'placeholder="'+a.placeholder+'"':"")+"></textarea></div>",c=$('<div class=""></div>').append(b);return c},renderInfoField:function(a){var b=this._getLabel(a)+'<div class="'+(a.controlcols?"col-lg-"+a.controlcols:"")+'"><input class="form-control info" id="'+a.id+'" disabled="disabled"></div>',c=$('<div class=""></div>').append(b);return c},_getLabel:function(a){return'<label for="'+a.id+'" class="control-label '+(a.labelcols?"col-lg-"+a.labelcols:"")+'">'+a.label+"</label>"},renderSelectField:function(a){var b=this._getLabel(a)+'<div class="'+(a.controlcols?"col-lg-"+a.controlcols:"")+'"><select id="'+a.id+'" class="form-control"></div>',c=$('<div class=""></div>').append(b);return c},renderButton:function(a){var a=$('<button id="'+a.id+'" class="btn btn-primary btn-lg" data-toggle="modal">'+a.label+"</button>");return a},renderTabsRoot:function(a){return $('<div id="'+a.id+'"></div>')},renderTabsHead:function(a){return $('<ul class="nav nav-tabs"></ul>')},renderTabsBody:function(a){return $('<div class="tab-content"></ul>')},renderTabTitle:function(a,b){return $("<li"+(b?' class="active"':"")+'><a href="#'+a.id+'" data-toggle="tab">'+a.label+"</li>")},renderTabContent:function(a,b){return $('<div class="tab-pane fade '+(b?" in active":"")+'" id="'+a.id+'"></div>')},renderTableContainer:function(a){return $('<div class="table-responsive"></div>')},renderTable:function(a){return $('<table id="'+a.id+'" class="table table-striped table-bordered table-hover"></table>')},renderTableHead:function(a){return this.renderTableHeadFoot(a,"thead")},renderTableFoot:function(a){return this.renderTableHeadFoot(a,"tfoot")},renderTableHeadFoot:function(a,b){for(var c=$("<"+b+"></"+b+">"),d=$("<tr></tr>"),e=0;e<a.columns.length;e++)d.append($("<th></th>").html(a.columns[e].label));return c.append(d),c},renderAccordionRoot:function(a){return $('<div id="'+a.id+'"></div>')},renderAccordionItemRoot:function(a){return $('<div class="panel panel-default"></div>')},renderAccordionItemHead:function(a){return $('<div class="panel-heading"></div>').append($('<h4 class="panel-title"></h4>').append('<a _target="label" data-toggle="collapse" data-parent="#'+a.parent.id+'" href="#'+a.id+'">'+a.label+"</a>"))},renderAccordionItemContent:function(a){return $('<div id="'+a.id+'" class="panel-collapse collapse'+(0===a.index?" in":"")+'">')},renderAccordionItemBody:function(a){return $('<div class="panel-body"></div>')},clearBreadcrumb:function(a){$("ul#"+a.id+".breadcrumb").html("")},renderBreadcrumbContainer:function(a){return $('<ul id="'+a.id+'" class="breadcrumb"></ul>')},renderBreadcrumbItem:function(a,b,c){return b?$('<li id="'+a.id+'" class="active">'+a.label+"</li>"):$('<li id="'+a.id+'"></li>').append($('<a href="#">'+a.label+"</a>").click(function(){return c?c.call(a):void 0}))},renderMessage:function(a){var b=$('<div class="alert alert-success alert-dismissable"></div>'),c=$('<button type="button" class="close" data-dismiss="alert" aria-hidden="true">×</button>');return b.append(c),b},changeAlertType:function(a,b){a.$jq.removeClass("alert-success alert-info alert-warning alert-danger"),a.$jq.addClass("alert-"+b)}}),Package.Register("forms"),forms.Application=Class.extend({navigation:[],activeform:null,formsdefs:{},forms:{},rootUrl:null,selector:null,init:function(a){$.extend(this,a)},addItem:function(a){},loadform:function(claz,params,callback){var ctx=this,frmpath=(this.rootUrl?this.rootUrl:"")+claz.replace(/\./g,"/");$.ajax({url:frmpath,type:"POST",data:params,dataType:"script",success:function(scr){ctx.defidx[claz]=eval(scr),callback&&callback.call(ctx)}})},createform:function(a,b){var c=this,d=function(a){var d=new a(b);c.formsdefs[d.id]=a,d.render(c.selector),c.forms[d.id]=d};if("function"==typeof a)return void d(a);if("object"==typeof a)a=forms.BaseForm.extend(a),d(a);else if("string"==typeof a)throw"Not implemented yet"},destroyform:function(a){this.activeform==a&&(this.activeform=null);for(var b=0;b<this.navigation.length;b++)if(this.navigation[b].id==a){this.navigation.splice(b,1);break}var c=this.forms[a];c.destroy(),delete this.forms[a],delete this.formsdefs[a]},showform:function(a){this.activeform=a,this.navigation.length>0&&this.navigation[this.navigation.length-1].show(!1),this.navigation.push(this.forms[a]),this.navigation[this.navigation.length-1].show(!0),this.updatebreadcrumb()},back:function(){if(!(this.navigation.length<=1)){var a=this.navigation[this.navigation.length-1],b=this.navigation[this.navigation.length-2];a.show(!1),b.show(!0),this.navigation.splice(this.navigation.length-1,1),this.activeform=b.id,this.updatebreadcrumb()}},updatebreadcrumb:function(){var a=forms.controls.ControlManagerInstance.renderer,b={id:"appbreadcrumb"};a.clearBreadcrumb(b),$(this.selector).find("#"+b.id).length||$(this.selector).prepend(a.renderBreadcrumbContainer(b));for(var c=this,d=0;d<this.navigation.length;d++){var e=this.navigation[d];$("#"+b.id).append(a.renderBreadcrumbItem(e,e.id==this.activeform,function(){c.activeform!==this.id&&c.back()}))}}}),Package.Register("forms"),forms.BaseForm=Class.extend({items:null,db:null,rendererImpl:null,validationViewer:null,$jq:null,idx:{byid:{}},refmap:{},init:function(){this.rendererImpl=eval("new forms.renderer."+this.renderer+"Renderer()"),this.validationViewer&&(this.validationViewer=eval("new forms.valid."+this.validationViewer+"View()")),this.preprocess(),this.itemsdb=SpahQL.db(this.items)},render:function(a){var b=this.rendererImpl,c=b.renderitems(this),d=b.renderForm(this);d.hide(),this.$jq=d.append(c),$(a).append(this.$jq),this.onafterrender(this)},onchange:function(a,b){this.notifyrefs(a,b)},notifyrefs:function(a,b){var c=this.refmap[a.id];if(c)for(var d=0;d<c.length;d++){var e=c[d],f=a.val();b&&"keypress"==b.type&&(f+=String.fromCharCode(b.charCode)),e.val(f)}},onafterrender:function(a){for(var b=0;b<a.items.length;b++){var c=a.items[b],d=forms.controls.ControlManagerInstance.idx[c.type];if(!d)return;d.onafterrender(c)}},preprocess:function(){for(var a=0;a<this.items.length;a++)this.preprocessfield(this.items[a])},preprocessfield:function(a,b){a.form=this;var c=forms.controls.ControlManagerInstance.idx[a.type];c.preprocess(a,b)},destroy:function(){for(var a=0;a<this.items.length;a++){var b=this.items[a],c=forms.controls.ControlManagerInstance.idx[b.type];c.destroy(b)}this.$jq.remove()},initDb:function(a){this.db||(a||(a={}),this.db=SpahQL.db(a))},scatter:function(a){this.initDb(a);for(var b=0;b<this.items.length;b++)this.scatterField(this.items[b])},gather:function(){this.initDb();for(var a=0;a<this.items.length;a++)this.gatherField(this.items[a])},gatherField:function(a){var b=forms.controls.ControlManagerInstance.idx[a.type];if(b.gather&&b.gather(a),a.items)for(var c=0;c<a.items.length;c++)this.gatherField(a.items[c])},scatterField:function(a){var b=forms.controls.ControlManagerInstance.idx[a.type];if(b.scatter&&b.scatter(a),a.items)for(var c=0;c<a.items.length;c++)this.scatterField(a.items[c])},show:function(a){a?this.$jq.show():this.$jq.hide()},validate:function(){for(var a=[],b=0;b<this.items.length;b++){var c=forms.controls.ControlManagerInstance.idx[this.items[b].type],d=this.items[b],e=c.validate(d);a=a.concat(e)}var f=this;return{result:a,show:function(){f.validationViewer.show(a)}}}});